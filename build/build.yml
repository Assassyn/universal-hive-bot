# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  paths:
    exclude:
      - README.md
      - .build/*
      - .editorconfig

pool:
  vmImage: ubuntu-latest

name: 0.1.0$(Rev:r)

stages:
  - stage: Build
    jobs:
      - job: 
        steps:
          - task: UseDotNet@2
            inputs:
              packageType: 'sdk'
              useGlobalJson: true
          - task: DotNetCoreCLI@2
            displayName: restore
            inputs:
              command: 'restore'
              projects: '**/*.fsproj'
              feedsToUse: 'select'
          - task: DotNetCoreCLI@2
            inputs:
              command: 'custom'
              custom: 'cake'
              arguments: './build/build.cake --target=test'

  - stage: Publish 
    dependsOn: Build
    condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))
    jobs: 
      - job: linux_arm 
        steps:
          - task: UseDotNet@2
            inputs:
              packageType: 'sdk'
              useGlobalJson: true
          - task: DotNetCoreCLI@2
            displayName: restore
            inputs:
              command: 'restore'
              projects: '**/*.fsproj'
              feedsToUse: 'select'
          - task: DotNetCoreCLI@2
            inputs:
              command: 'custom'
              custom: 'cake'
              arguments: './build/build.cake --target=Pack --build=$(Build.BuildNumber)'
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: './build/artifacts'
              artifact: 'packages'
              publishLocation: 'pipeline'

  - stage: push_2_github
    dependsOn: Publish
    jobs: 
      - job: copy_2_github
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'current'
              artifactName: 'packages'
              targetPath: '$(Build.ArtifactStagingDirectory)'
          - task: GitHubRelease@1
            inputs:
              gitHubConnection: 'github.com_Assassyn'
              repositoryName: 'functional-solutions/splinterbots'
              action: 'create'
              target: '$(Build.SourceVersion)'
              tagSource: 'userSpecifiedTag'
              tag: 'release-$(Build.BuildNumber)'
              title: '$(Build.BuildNumber)'
              isDraft: true
              changeLogCompareToRelease: 'lastFullRelease'
              changeLogType: 'commitBased'
